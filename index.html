<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Slide Puzzle</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --accent: #8b5cf6; 
            --bg-body: #f1f5f9;
            --surface: #ffffff;
            --surface-2: #e2e8f0;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #cbd5e1;
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --surface: #1e293b;
            --surface-2: #334155;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --border: rgba(255,255,255,0.1);
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; transition: background 0.3s, color 0.3s, border-color 0.3s; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            position: relative;
        }

        /* --- Z-INDEX FIX: Confetti on Top --- */
        #confetti-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 99999; /* Highest priority */
        }

        /* Theme Toggle */
        .theme-toggle {
            position: absolute; top: 20px; right: 20px;
            background: var(--surface); border: 1px solid var(--border);
            color: var(--text-main); width: 45px; height: 45px;
            border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; box-shadow: var(--shadow); z-index: 50;
        }

        #app { width: 100%; max-width: 450px; padding: 20px; flex-grow: 1; display: flex; align-items: center; justify-content: center; }

        .screen { display: none; width: 100%; animation: fadeUp 0.4s ease forwards; }
        .screen.active { display: block; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Menu */
        .title { text-align: center; font-size: 2.5rem; font-weight: 800; margin-bottom: 25px; background: linear-gradient(135deg, var(--primary), #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 24px; padding: 30px; box-shadow: var(--shadow); }
        .label { display: block; font-size: 0.8rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.5px; }
        .segment-box { display: flex; background: var(--surface-2); padding: 5px; border-radius: 14px; gap: 5px; margin-bottom: 25px; }
        .segment-btn { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-sub); font-weight: 600; border-radius: 10px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; }
        .segment-btn.active { background: var(--surface); color: var(--text-main); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn-start, .btn-action { width: 100%; padding: 18px; border: none; border-radius: 16px; background: var(--primary); color: white; font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4); transition: transform 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-start:active { transform: scale(0.98); }
        .btn-ai { background: linear-gradient(135deg, #8b5cf6, #7c3aed); box-shadow: 0 10px 20px -5px rgba(139, 92, 246, 0.4); margin-bottom: 15px; }

        /* Game Board */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .game-stats { text-align: center; }
        .game-stats h2 { font-size: 1.2rem; font-weight: 800; color: var(--text-main); margin-bottom: 2px; }
        .game-stats p { font-size: 0.85rem; color: var(--text-sub); font-weight: 600; }
        .icon-btn { width: 45px; height: 45px; border-radius: 50%; border: 1px solid var(--border); background: var(--surface); color: var(--text-sub); font-size: 1.1rem; cursor: pointer; }
        .icon-btn:hover { color: var(--text-main); border-color: var(--text-sub); }

        #puzzle_container { position: relative; width: 100%; height: 0; padding-bottom: 100%; background: var(--surface-2); border-radius: 20px; margin-bottom: 25px; overflow: hidden; border: 4px solid var(--surface-2); }
        .puzzle_block { position: absolute; background: var(--surface); color: var(--text-main); font-weight: 800; display: flex; justify-content: center; align-items: center; cursor: pointer; border-radius: 14px; box-shadow: inset 0 0 0 2px var(--border), 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); user-select: none; }
        .puzzle_block:active { transform: scale(0.95); }
        .puzzle_block.hint-target { border: 3px solid var(--accent); color: var(--accent); box-shadow: 0 0 15px rgba(139, 92, 246, 0.4); z-index: 10; }

        /* AI Popup */
        #ai_direction_popup { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: var(--accent); color: white; padding: 10px 20px; border-radius: 50px; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; box-shadow: 0 10px 25px rgba(139, 92, 246, 0.5); opacity: 0; visibility: hidden; transition: 0.3s; z-index: 100; }
        #ai_direction_popup.show { opacity: 1; visibility: visible; top: 90px; }

        .info-footer { display: flex; justify-content: center; margin-bottom: 10px; }
        .hint-text { font-size: 0.9rem; color: var(--text-sub); font-weight: 600; }
        .dev-footer { width: 100%; text-align: center; padding: 20px; font-size: 0.9rem; color: var(--text-sub); margin-top: auto; }
        .dev-name { font-weight: 700; color: var(--text-main); }
        .social-link { display: inline-flex; align-items: center; gap: 8px; text-decoration: none; font-weight: 600; color: #1877F2; padding: 5px 15px; border-radius: 50px; background: rgba(24, 119, 242, 0.1); transition: 0.3s; margin-top: 5px; }
        .social-link:hover { background: #1877F2; color: white; transform: translateY(-2px); }

        /* --- CUSTOM MODAL OVERLAY (Replaces Native Dialog) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000; /* Lower than confetti (99999) */
            opacity: 0; visibility: hidden;
            transition: 0.3s ease;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }

        .modal-content {
            background: var(--surface);
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            width: 90%; max-width: 350px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            transform: scale(0.8);
            transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.show .modal-content { transform: scale(1); }

    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <button class="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <div id="ai_direction_popup">
        <i class="fas fa-robot"></i> Move <span id="dir_arrow">RIGHT</span>
    </div>

    <div id="app">
        <div id="menu-screen" class="screen active">
            <h1 class="title">Slide Puzzle</h1>
            <div class="card">
                <span class="label">Grid Size</span>
                <div class="segment-box">
                    <button class="segment-btn active" onclick="setGridSize(3, this)">3x3</button>
                    <button class="segment-btn" onclick="setGridSize(4, this)">4x4</button>
                    <button class="segment-btn" onclick="setGridSize(5, this)">5x5</button>
                </div>
                <span class="label">Difficulty</span>
                <div class="segment-box">
                    <button class="segment-btn active" onclick="setDifficulty(1, this)">Easy</button>
                    <button class="segment-btn" onclick="setDifficulty(2, this)">Medium</button>
                    <button class="segment-btn" onclick="setDifficulty(3, this)">Hard</button>
                </div>
                <button class="btn-start" onclick="startGame()">Start Game</button>
            </div>
        </div>

        <div id="game-screen" class="screen">
            <div class="header">
                <button class="icon-btn" onclick="toMenu()"><i class="fas fa-arrow-left"></i></button>
                <div class="game-stats">
                    <h2 id="timer">00:00</h2>
                    <p>Moves: <span id="move_count">0</span></p>
                </div>
                <button class="icon-btn" onclick="game.resetLevel()"><i class="fas fa-redo"></i></button>
            </div>

            <div id="puzzle_container"></div>

            <button id="ai_btn" class="btn-action btn-ai" onclick="aiAssistant.getHint()">
                <i class="fas fa-robot"></i> AI Hint (<span id="hint_count">3</span>)
            </button>
            
            <div class="info-footer">
                <span class="hint-text">Arrange the numbers in order.</span>
            </div>
        </div>
    </div>

    <footer class="dev-footer">
        <p>Developed by <span class="dev-name">Jamiul Hasan</span></p>
        <a href="https://www.facebook.com/jamiul2168" target="_blank" class="social-link">
            <i class="fab fa-facebook"></i> jamiul2168
        </a>
    </footer>

    <div id="result-overlay" class="modal-overlay">
        <div class="modal-content">
            <div style="font-size:3.5rem; margin-bottom:15px; animation: bounce 1s infinite;">üèÜ</div>
            <h2 style="font-size:2rem; margin-bottom:10px; color:var(--primary); font-weight:800;">Solved!</h2>
            <p style="color:var(--text-sub); margin-bottom:5px; font-weight:600;">Moves: <span id="final_moves" style="color:var(--text-main);">0</span></p>
            <p style="color:var(--text-sub); margin-bottom:25px; font-weight:600;">Time: <span id="final_time" style="color:var(--text-main);">00:00</span></p>
            <button class="btn-start" onclick="closeModal()">Play Again</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        // --- CONFIG ---
        let config = { size: 3, difficulty: 1 };
        const DifficultyIterations = [15, 40, 80];

        // --- THEME ---
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            if (html.getAttribute('data-theme') === 'light') {
                html.setAttribute('data-theme', 'dark');
                icon.className = 'fas fa-sun';
            } else {
                html.setAttribute('data-theme', 'light');
                icon.className = 'fas fa-moon';
            }
        }

        // --- MENU ---
        function setGridSize(size, btn) {
            config.size = size;
            updateSegment(btn);
        }
        function setDifficulty(level, btn) {
            config.difficulty = level;
            updateSegment(btn);
        }
        function updateSegment(btn) {
            [...btn.parentElement.children].forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
        }
        function startGame() {
            document.getElementById('menu-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            game.init(config.size, config.difficulty);
            aiAssistant.reset();
        }
        function toMenu() {
            game.stopTimer();
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('menu-screen').classList.add('active');
        }

        // --- GAME ENGINE ---
        class Game {
            constructor() {
                this.container = document.getElementById("puzzle_container");
                this.blocks = [];
                this.moves = 0;
                this.timerInterval = null;
                this.seconds = 0;
            }

            init(size, difficulty) {
                this.cols = size;
                this.count = size * size;
                this.empty = {x: size-1, y: size-1};
                this.moves = 0;
                this.seconds = 0;
                this.difficulty = difficulty;
                
                this.createGrid();
                this.randomize();
                this.startTimer();
                this.updateUI();
            }

            createGrid() {
                this.container.innerHTML = '';
                this.blocks = [];
                const sizePct = 100 / this.cols;
                const gap = 4;
                
                for(let i=0; i<this.count - 1; i++) {
                    const block = document.createElement('div');
                    block.className = 'puzzle_block';
                    block.textContent = i + 1;
                    block.style.width = `calc(${sizePct}% - ${gap}px)`;
                    block.style.height = `calc(${sizePct}% - ${gap}px)`;
                    block.style.fontSize = `${160/this.cols}px`;
                    
                    const x = i % this.cols;
                    const y = Math.floor(i / this.cols);
                    this.setPosition(block, x, y);
                    
                    block.onclick = () => this.clickBlock(i);
                    this.container.appendChild(block);
                    this.blocks.push({el: block, x: x, y: y, idx: i});
                }
            }

            setPosition(el, x, y) {
                const sizePct = 100 / this.cols;
                const gap = 2;
                el.style.left = `calc(${x * sizePct}% + ${gap}px)`;
                el.style.top = `calc(${y * sizePct}% + ${gap}px)`;
            }

            clickBlock(originalIdx) {
                const block = this.blocks.find(b => b.idx === originalIdx);
                if(this.canMove(block)) {
                    this.move(block);
                    aiAssistant.clearHint();
                    if(this.checkWin()) this.endGame();
                }
            }

            canMove(block) {
                const dx = Math.abs(block.x - this.empty.x);
                const dy = Math.abs(block.y - this.empty.y);
                return (dx === 1 && dy === 0) || (dx === 0 && dy === 1);
            }

            move(block) {
                const tempX = block.x;
                const tempY = block.y;
                block.x = this.empty.x;
                block.y = this.empty.y;
                this.empty.x = tempX;
                this.empty.y = tempY;
                
                this.setPosition(block.el, block.x, block.y);
                this.moves++;
                document.getElementById('move_count').textContent = this.moves;
            }

            randomize() {
                const iterations = DifficultyIterations[this.difficulty - 1] * (this.cols - 1);
                for(let i=0; i<iterations; i++) {
                    const neighbors = this.blocks.filter(b => this.canMove(b));
                    const randBlock = neighbors[Math.floor(Math.random() * neighbors.length)];
                    this.move(randBlock);
                }
                this.moves = 0;
                document.getElementById('move_count').textContent = 0;
            }

            checkWin() {
                for(let b of this.blocks) {
                    const targetX = b.idx % this.cols;
                    const targetY = Math.floor(b.idx / this.cols);
                    if(b.x !== targetX || b.y !== targetY) return false;
                }
                return true;
            }

            startTimer() {
                this.stopTimer();
                this.timerInterval = setInterval(() => {
                    this.seconds++;
                    this.updateUI();
                }, 1000);
            }
            stopTimer() { clearInterval(this.timerInterval); }
            
            updateUI() {
                const m = Math.floor(this.seconds / 60).toString().padStart(2,'0');
                const s = (this.seconds % 60).toString().padStart(2,'0');
                document.getElementById('timer').textContent = `${m}:${s}`;
            }

            resetLevel() {
                this.randomize();
                this.seconds = 0;
                this.startTimer();
                this.updateUI();
                aiAssistant.reset();
            }

            endGame() {
                this.stopTimer();
                const m = Math.floor(this.seconds / 60).toString().padStart(2,'0');
                const s = (this.seconds % 60).toString().padStart(2,'0');
                document.getElementById('final_moves').innerText = this.moves;
                document.getElementById('final_time').innerText = `${m}:${s}`;
                
                // Show Custom Modal
                document.getElementById('result-overlay').classList.add('show');
                
                // Trigger Confetti ON TOP
                triggerConfetti();
            }
        }

        // --- AI ---
        class AIAssistant {
            constructor() {
                this.hints = 3;
                this.btn = document.getElementById('ai_btn');
                this.countSpan = document.getElementById('hint_count');
                this.popup = document.getElementById('ai_direction_popup');
                this.arrow = document.getElementById('dir_arrow');
            }
            reset() {
                this.hints = 3;
                this.updateBtn();
                this.clearHint();
            }
            updateBtn() {
                this.countSpan.innerText = this.hints;
                this.btn.style.opacity = this.hints <= 0 ? 0.5 : 1;
                this.btn.style.pointerEvents = this.hints <= 0 ? 'none' : 'auto';
            }
            clearHint() {
                document.querySelectorAll('.hint-target').forEach(el => el.classList.remove('hint-target'));
                this.popup.classList.remove('show');
            }
            getHint() {
                if(this.hints <= 0) return;
                const bestMove = this.findMove();
                if(bestMove) {
                    this.hints--;
                    this.updateBtn();
                    this.clearHint();
                    bestMove.el.classList.add('hint-target');
                    
                    let dirText = "";
                    if (bestMove.x < game.empty.x) dirText = "RIGHT <i class='fas fa-arrow-right'></i>";
                    else if (bestMove.x > game.empty.x) dirText = "LEFT <i class='fas fa-arrow-left'></i>";
                    else if (bestMove.y < game.empty.y) dirText = "DOWN <i class='fas fa-arrow-down'></i>";
                    else if (bestMove.y > game.empty.y) dirText = "UP <i class='fas fa-arrow-up'></i>";
                    
                    this.arrow.innerHTML = dirText;
                    this.popup.classList.add('show');
                    setTimeout(() => this.popup.classList.remove('show'), 3000);
                }
            }
            findMove() {
                const candidates = game.blocks.filter(b => game.canMove(b));
                if(candidates.length === 0) return null;
                let bestBlock = null, minDistance = Infinity;

                candidates.forEach(block => {
                    const origX = block.x, origY = block.y;
                    const emptyX = game.empty.x, emptyY = game.empty.y;
                    block.x = emptyX; block.y = emptyY; 
                    
                    let totalDist = 0;
                    game.blocks.forEach(b => {
                        const targetX = b.idx % game.cols;
                        const targetY = Math.floor(b.idx / game.cols);
                        totalDist += Math.abs(b.x - targetX) + Math.abs(b.y - targetY);
                    });

                    if(totalDist < minDistance) { minDistance = totalDist; bestBlock = block; }
                    block.x = origX; block.y = origY; 
                });
                return bestBlock || candidates[0];
            }
        }

        // --- FIREWORKS CONFETTI (High Z-Index) ---
        function triggerConfetti() {
            var duration = 3000;
            var end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    zIndex: 99999
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    zIndex: 99999
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

        const game = new Game();
        const aiAssistant = new AIAssistant();

        function closeModal() {
            document.getElementById('result-overlay').classList.remove('show');
            game.resetLevel();
        }
    </script>
</body>
</html>
